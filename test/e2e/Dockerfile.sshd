FROM alpine:3.19

ARG AUTH_TYPE=key

RUN apk add --no-cache openssh-server bash procps

RUN ssh-keygen -A

RUN adduser -D -s /bin/bash testuser && \
    mkdir -p /home/testuser/.ssh && \
    chown testuser:testuser /home/testuser/.ssh && \
    chmod 700 /home/testuser/.ssh

# Key-based auth setup
COPY testdata/id_ed25519.pub /tmp/id_ed25519.pub
RUN if [ "$AUTH_TYPE" = "key" ]; then \
        cp /tmp/id_ed25519.pub /home/testuser/.ssh/authorized_keys && \
        chown testuser:testuser /home/testuser/.ssh/authorized_keys && \
        chmod 600 /home/testuser/.ssh/authorized_keys && \
        echo "testuser:$(head -c 32 /dev/urandom | base64)" | chpasswd && \
        sed -i 's/^#*PasswordAuthentication.*/PasswordAuthentication no/' /etc/ssh/sshd_config && \
        sed -i 's/^#*PubkeyAuthentication.*/PubkeyAuthentication yes/' /etc/ssh/sshd_config; \
    fi

# Password-based auth setup
RUN if [ "$AUTH_TYPE" = "password" ]; then \
        echo "testuser:testpass123" | chpasswd && \
        sed -i 's/^#*PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config && \
        sed -i 's/^#*PubkeyAuthentication.*/PubkeyAuthentication no/' /etc/ssh/sshd_config; \
    fi

# Common sshd config - remove UsePAM (unsupported on Alpine) and configure
RUN sed -i 's/^#*PermitRootLogin.*/PermitRootLogin no/' /etc/ssh/sshd_config && \
    sed -i '/^#*UsePAM/d' /etc/ssh/sshd_config && \
    echo "AllowUsers testuser" >> /etc/ssh/sshd_config

EXPOSE 22

CMD ["/usr/sbin/sshd", "-D", "-e"]
